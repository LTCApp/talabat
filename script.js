class WholesaleProductExtractor {
    constructor() {
        this.products = [];
        this.filteredProducts = [];
        this.init();
    }

    init() {
        this.bindEvents();
        this.loadSampleData();
    }

    bindEvents() {
        const storeSelect = document.getElementById('storeSelect');
        const customUrl = document.getElementById('customUrl');
        const extractBtn = document.getElementById('extractBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const searchFilter = document.getElementById('searchFilter');
        const statusFilter = document.getElementById('statusFilter');

        storeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                customUrl.style.display = 'block';
                customUrl.focus();
            } else {
                customUrl.style.display = 'none';
            }
        });

        extractBtn.addEventListener('click', () => this.extractProducts());
        exportBtn.addEventListener('click', () => this.exportData());
        clearBtn.addEventListener('click', () => this.clearData());
        searchFilter.addEventListener('input', () => this.applyFilters());
        statusFilter.addEventListener('change', () => this.applyFilters());
    }

    showStatus(message, type = 'info') {
        const status = document.getElementById('status');
        status.className = `status ${type}`;
        status.textContent = message;
        status.classList.remove('hidden');
    }

    showProgress(percentage) {
        const progress = document.getElementById('progress');
        const progressBar = progress.querySelector('.progress-bar');
        
        if (percentage === 0) {
            progress.classList.add('hidden');
        } else {
            progress.classList.remove('hidden');
            progressBar.style.width = `${percentage}%`;
        }
    }

    async extractProducts() {
        const storeSelect = document.getElementById('storeSelect');
        const customUrl = document.getElementById('customUrl');
        const extractBtn = document.getElementById('extractBtn');
        
        let url = storeSelect.value;
        if (url === 'custom') {
            url = customUrl.value.trim();
            if (!url) {
                this.showStatus('ูุฑุฌู ุฅุฏุฎุงู ุฑุงุจุท ุตุญูุญ', 'error');
                return;
            }
        }

        extractBtn.disabled = true;
        extractBtn.textContent = 'โณ ุฌุงุฑู ุงูุงุณุชุฎุฑุงุฌ...';
        
        this.showStatus('ุจุฏุก ุนูููุฉ ุงุณุชุฎุฑุงุฌ ุงูููุชุฌุงุช...', 'info');
        this.showProgress(20);

        try {
            // ูุญุงูุงุฉ ุนูููุฉ ุงูุงุณุชุฎุฑุงุฌ
            await this.simulateExtraction();
            
            this.showProgress(100);
            this.showStatus(`ุชู ุงุณุชุฎุฑุงุฌ ${this.products.length} ููุชุฌ ุจูุฌุงุญ!`, 'success');
            
            this.displayResults();
            
        } catch (error) {
            console.error('ุฎุทุฃ ูู ุงูุงุณุชุฎุฑุงุฌ:', error);
            this.showStatus('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุฎุฑุงุฌ ุงูููุชุฌุงุช', 'error');
        } finally {
            extractBtn.disabled = false;
            extractBtn.textContent = '๐ ุงุณุชุฎุฑุงุฌ ุงูููุชุฌุงุช';
            setTimeout(() => this.showProgress(0), 1000);
        }
    }

    async simulateExtraction() {
        // ูุญุงูุงุฉ ุชุฃุฎูุฑ ุงูุดุจูุฉ
        for (let i = 20; i <= 80; i += 20) {
            await new Promise(resolve => setTimeout(resolve, 500));
            this.showProgress(i);
        }
        
        // ุชุญุฏูุซ ุงูุจูุงูุงุช ูุน ููุชุฌุงุช ูู ุงูุจูุงูุงุช ุงูุญููููุฉ
        this.products = this.getSampleProducts();
        this.filteredProducts = [...this.products];
    }

    getSampleProducts() {
        return [
            {
                code: '2984',
                name: 'ุนุฑุถ (ุจูุงุดุฑ ุณุงุฆู ูุงุฑุณ ุฏุฑุฌู 101 Orange +ุจูุงุดุฑ ุณุงุฆู ูุงุฑุณ ุฏุฑุฌู 101 Orange+ุจูุงุดุฑ ุณุงุฆู ูุงุฑุณ ุฏุฑุฌู 103 Red+ุจูุงุดุฑ ุณุงุฆู ูุงุฑุณ ุฏุฑุฌู 104 Mahogany )',
                image: 'https://tager-uploads.s3.eu-central-1.amazonaws.com/c091e028-2a44-41b1-8a25-979440c172ee.jpg',
                price: 230,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            },
            {
                code: '2985',
                name: 'ุนุฑุถ (ูุฑุณุชูุงู ุฏููุฑ ุณููุงุฌ ูุงู ููุจู +ุญุธุงุธุฉ ูุฏ ุจููู ูุนุฏู )',
                image: 'https://tager-uploads.s3.eu-central-1.amazonaws.com/a276f20c-149d-4a18-adbf-1236ac301bbc.jpg',
                price: 120,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            },
            {
                code: '2986',
                name: 'ุนุฑุถ ( ุฏูุณุจูุณุฑ ุงูุตุงุจูู 2 ูู 1 + ููุชุฑ ููุงู ุจููู 2 ูู 1)',
                image: 'https://tager-uploads.s3.eu-central-1.amazonaws.com/ba81ccb8-5027-4903-b019-221de57ae1fd.jpg',
                price: 300,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            },
            {
                code: '2987',
                name: 'ุนุฑุถ ( ุณุงุนุฉ ุชุงุชุด ุฏุงุฆุฑูุฉ ุฃุณูุฏ + ูุญูุธุฉ ุฑุฌุงูู + ุณูุงุนุฉ ุจููุชูุซ ูุบูุงุทูุณูุฉ)',
                image: 'https://tager-uploads.s3.eu-central-1.amazonaws.com/0c0fd9c4-7a33-4b61-97c6-f8dbab8b791d.jpg',
                price: 170,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            },
            {
                code: '2988',
                name: 'ุนุฑุถ (ูุดุท ุฑุฌุงูู ููุฑุฏ ุงูุดุนุฑ ู ุงููุญูุฉ +ุณุงุนุฉ ุชุงุชุด ุฏุงุฆุฑูุฉ ุฃุณูุฏ)',
                image: 'https://tager-uploads.s3.eu-central-1.amazonaws.com/9d17aa94-3f2e-4ad7-bb7c-192d7be54758.jpg',
                price: 240,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            },
            {
                code: '2989',
                name: 'ุนุฑุถ 17 ูุทุนุฉ (ุนุฑุถ 12 ููู ููุจ ูุงููุฑ ุงู ุงู +ุจูุงุดุฑ ุฏุงููููุฏ 6 ุงูููุงู+ูุงููุงูุช + ุจุฑููุฒุฑ ุจุงููุช+ุจูุงุดุฑ + ูุงููุงูุชุฑ ุจุงููุช+ุนุฑุถ 10 ูุฑุด ููู ุงุจ+ููุจุฑ ุดูุงูู ูููุชูุฑูุง ุณููุฑูุช)',
                image: 'https://tager-uploads.s3.eu-central-1.amazonaws.com/0158a7cd-3d52-4585-9019-42ea83e789e3.jpg',
                price: 220,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            },
            {
                code: '2990',
                name: 'ุนุฑุถ ูุทุนุชูู ุฏุฑุฌ ุงูุซูุงุฌุฉ ุงูุนุฌูุจ',
                image: 'https://tager-uploads.s3.eu-central-1.amazonaws.com/fb3898c5-d8d1-46bd-a0e8-4375aafd85a2.jpg',
                price: 105,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            },
            {
                code: '2991',
                name: 'ุนุฑุถ ูุทุนุชูู ูุดุงู ุทุงูู ุดูุณูู ุตุบูุฑ',
                image: 'https://tager-uploads.s3.eu-central-1.amazonaws.com/cfb59642-ebf9-48ea-9127-c90f6ce571ed.jpg',
                price: 150,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            },
            {
                code: '2992',
                name: 'ุนุฑุถ 5 ูุทุน ุงุนูุงุฏ ุชุณููู ุงูุงุญูุงุถ ุงูุนุฌูุจุฉ',
                image: 'https://via.placeholder.com/200x200/f0f0f0/999?text=ูุง+ุชูุฌุฏ+ุตูุฑุฉ',
                price: 150,
                currency: 'ุฌููู',
                status: 'ุบูุฑ ูุชููุฑ'
            },
            {
                code: '2993',
                name: 'ุนุฑุถ ูุทุนุชูู ูุตูุฉ ุญูููุฉ Turbo Flex 360',
                image: 'https://via.placeholder.com/200x200/f0f0f0/999?text=ูุง+ุชูุฌุฏ+ุตูุฑุฉ',
                price: 170,
                currency: 'ุฌููู',
                status: 'ุบูุฑ ูุชููุฑ'
            },
            {
                code: '2994',
                name: 'ุณุงุนุฉ ุชุงุชุด ุฏุงุฆุฑูุฉ ุฃุณูุฏ + ุญุธุงุธุฉ ูุฏ ุจููู ูุนุฏู + ุนุฑุถ 3 ุชูุดูุฑุช ุฏูุฌูุชุงู ุตููู',
                image: 'https://via.placeholder.com/200x200/f0f0f0/999?text=ูุง+ุชูุฌุฏ+ุตูุฑุฉ',
                price: 180,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            },
            {
                code: '2999',
                name: 'ุนุฑุถ ( ููุธู ูุนุฏุฉ ุงูุณูุงุฑุฉ +ููุธู ุณูุงุฑุฉ ุจUSB)',
                image: 'https://via.placeholder.com/200x200/f0f0f0/999?text=ูุง+ุชูุฌุฏ+ุตูุฑุฉ',
                price: 220,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            },
            {
                code: '3000',
                name: 'ุนุฑุถ ุดุฑุงุจ ุฑูุจุฉ ุฒุญู ููุฃุทูุงู +ุฌูุงูุชู ุชุณููู ุงูุงุทูุงู',
                image: 'https://via.placeholder.com/200x200/f0f0f0/999?text=ูุง+ุชูุฌุฏ+ุตูุฑุฉ',
                price: 160,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            },
            {
                code: '3001',
                name: 'ุนุฑุถ (2 ุทูู ุดุฑุงุจ ุฑูุจุฉ ุฒุญู ููุฃุทูุงู )',
                image: 'https://via.placeholder.com/200x200/f0f0f0/999?text=ูุง+ุชูุฌุฏ+ุตูุฑุฉ',
                price: 115,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            },
            {
                code: '3002',
                name: 'ุนุฑุถ (ุงูููู ุงูุงููููุฑ ูุงุตู ุงูุฑููุด +ุนุฑุถ 3 ูุทุน ุฑููุด 5D )',
                image: 'https://via.placeholder.com/200x200/f0f0f0/999?text=ูุง+ุชูุฌุฏ+ุตูุฑุฉ',
                price: 170,
                currency: 'ุฌููู',
                status: 'ูุชููุฑ'
            }
        ];
    }

    loadSampleData() {
        // ุชุญููู ุจูุงูุงุช ุชุฌุฑูุจูุฉ ุนูุฏ ุจุฏุก ุงูุชุดุบูู
        this.products = this.getSampleProducts();
        this.filteredProducts = [...this.products];
        this.displayResults();
        this.showStatus('ุชู ุชุญููู ุจูุงูุงุช ุชุฌุฑูุจูุฉ ููุนุฑุถ', 'info');
    }

    displayResults() {
        const resultsHeader = document.querySelector('.results-header');
        const filterSection = document.querySelector('.filter-section');
        const productsTable = document.getElementById('productsTable');
        const exportBtn = document.getElementById('exportBtn');

        // ุฅุธูุงุฑ ุงูุนูุงุตุฑ
        resultsHeader.classList.remove('hidden');
        filterSection.classList.remove('hidden');
        productsTable.classList.remove('hidden');
        exportBtn.disabled = false;

        this.updateSummary();
        this.renderTable();
    }

    updateSummary() {
        const totalCount = document.getElementById('totalCount');
        const availableCount = document.getElementById('availableCount');
        const unavailableCount = document.getElementById('unavailableCount');

        const available = this.products.filter(p => p.status === 'ูุชููุฑ').length;
        const unavailable = this.products.filter(p => p.status === 'ุบูุฑ ูุชููุฑ').length;

        totalCount.textContent = this.products.length;
        availableCount.textContent = available;
        unavailableCount.textContent = unavailable;
    }

    renderTable() {
        const productsTable = document.getElementById('productsTable');
        
        const tableHTML = `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ุฑูู ุงูููุชุฌ</th>
                            <th>ููุฏ ุงูููุชุฌ</th>
                            <th>ุตูุฑุฉ ุงูููุชุฌ</th>
                            <th>ุงุณู ุงูููุชุฌ</th>
                            <th>ุงูุณุนุฑ</th>
                            <th>ุงูุญุงูุฉ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${this.filteredProducts.map((product, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td><span class="product-code">${product.code}</span></td>
                                <td>
                                    <img src="${product.image}" alt="${product.name}" class="product-image" 
                                         onerror="this.src='https://via.placeholder.com/60x60/f0f0f0/999?text=ูุง+ุชูุฌุฏ'">
                                </td>
                                <td class="product-name">${product.name}</td>
                                <td class="product-price">${product.price} ${product.currency}</td>
                                <td>
                                    <span class="status-badge ${product.status === 'ูุชููุฑ' ? 'status-available' : 'status-unavailable'}">
                                        ${product.status}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        productsTable.innerHTML = tableHTML;
    }

    applyFilters() {
        const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;

        this.filteredProducts = this.products.filter(product => {
            const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                product.code.toLowerCase().includes(searchTerm);
            
            const matchesStatus = statusFilter === 'all' || 
                                (statusFilter === 'available' && product.status === 'ูุชููุฑ') ||
                                (statusFilter === 'unavailable' && product.status === 'ุบูุฑ ูุชููุฑ');
            
            return matchesSearch && matchesStatus;
        });

        this.renderTable();
    }

    exportData() {
        if (this.products.length === 0) {
            this.showStatus('ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ', 'error');
            return;
        }

        // ุชุตุฏูุฑ CSV
        const csvData = this.convertToCSV();
        this.downloadFile(csvData, 'wholesale_products.csv', 'text/csv');
        
        // ุชุตุฏูุฑ JSON
        const jsonData = JSON.stringify(this.products, null, 2);
        this.downloadFile(jsonData, 'wholesale_products.json', 'application/json');
        
        this.showStatus('ุชู ุชุตุฏูุฑ ุงูุจูุงูุงุช ุจุตูุบุชู CSV ู JSON', 'success');
    }

    convertToCSV() {
        const headers = ['ููุฏ ุงูููุชุฌ', 'ุงุณู ุงูููุชุฌ', 'ุงูุณุนุฑ', 'ุงูุนููุฉ', 'ุงูุญุงูุฉ', 'ุฑุงุจุท ุงูุตูุฑุฉ'];
        const rows = this.products.map(product => [
            product.code,
            `"${product.name}"`,
            product.price,
            product.currency,
            product.status,
            product.image
        ]);
        
        return [headers, ...rows].map(row => row.join(',')).join('\n');
    }

    downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    clearData() {
        if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ุฌููุน ุงูุจูุงูุงุชุ')) {
            this.products = [];
            this.filteredProducts = [];
            
            // ุฅุฎูุงุก ุงููุชุงุฆุฌ
            document.querySelector('.results-header').classList.add('hidden');
            document.querySelector('.filter-section').classList.add('hidden');
            document.getElementById('productsTable').classList.add('hidden');
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('status').classList.add('hidden');
            
            this.showStatus('ุชู ูุณุญ ุฌููุน ุงูุจูุงูุงุช', 'info');
        }
    }
}

// ุชุดุบูู ุงูุชุทุจูู
document.addEventListener('DOMContentLoaded', () => {
    new WholesaleProductExtractor();
});